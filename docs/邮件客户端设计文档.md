# Android邮件客户端设计文档

## 项目概述

基于Python + Kivy + Buildozer开发的轻量级Android邮件客户端，支持IMAP/SMTP协议收发邮件。

## 技术栈

- **UI框架**: Kivy 2.x
- **邮件协议**: imaplib (IMAP), smtplib (SMTP)
- **打包工具**: Buildozer
- **部署方式**: GitHub Actions自动构建APK

## 核心功能模块

### 1. 账户管理模块
**功能**:
- 添加/删除邮箱账户
- 支持多账户切换
- 账户信息加密存储在设备本地

**技术实现**:
- 使用JSON存储账户配置
- 密码使用AES加密（密钥基于设备标识）
- 配置文件路径: 应用私有目录（`App.user_data_dir`）
- **用户通过登录界面输入密码，仅存储在本地设备**

**数据结构**:
```python
{
    "accounts": [
        {
            "id": "uuid",
            "email": "user@example.com",
            "name": "用户名",
            "imap_server": "imap.example.com",
            "imap_port": 993,
            "smtp_server": "smtp.example.com", 
            "smtp_port": 465,
            "password": "encrypted_password",  # AES加密后的密码
            "use_ssl": true
        }
    ],
    "default_account": "uuid"
}
```

### 2. 邮件收取模块
**功能**:
- 连接IMAP服务器
- 获取邮件列表（收件箱/已发送/垃圾箱等）
- 下载邮件内容和附件
- 标记已读/未读
- 删除邮件

**技术实现**:
```python
import imaplib
import email
from email.header import decode_header

class IMAPClient:
    def connect(server, port, email, password):
        # 连接IMAP服务器
        pass
    
    def fetch_folders():
        # 获取文件夹列表
        pass
    
    def fetch_emails(folder, limit=50):
        # 获取邮件列表
        pass
    
    def get_email_content(email_id):
        # 获取邮件详情
        pass
    
    def mark_as_read(email_id):
        # 标记已读
        pass
```

**邮件列表数据结构**:
```python
{
    "id": "email_uid",
    "from": "sender@example.com",
    "to": ["recipient@example.com"],
    "subject": "邮件主题",
    "date": "2025-11-03 22:40:00",
    "preview": "邮件预览前100字...",
    "has_attachment": true,
    "is_read": false,
    "size": 12345
}
```

### 3. 邮件发送模块
**功能**:
- 撰写新邮件
- 回复/转发邮件
- 添加附件
- 发送邮件

**技术实现**:
```python
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.mime.base import MIMEBase

class SMTPClient:
    def connect(server, port, email, password):
        # 连接SMTP服务器
        pass
    
    def send_email(to, subject, body, attachments=[]):
        # 发送邮件
        pass
    
    def send_html_email(to, subject, html_body):
        # 发送HTML邮件
        pass
```

### 4. UI界面模块

#### 4.1 登录界面
- 邮箱地址输入
- 密码输入
- IMAP/SMTP服务器配置（可选高级设置）
- 常见邮箱服务商快速配置（Gmail/Outlook/QQ/163等）

#### 4.2 邮件列表界面
- 顶部：账户切换、刷新按钮
- 侧边栏：文件夹列表（收件箱/已发送/草稿箱/垃圾箱）
- 主区域：邮件列表（显示发件人、主题、时间、预览）
- 底部：撰写新邮件按钮

#### 4.3 邮件详情界面
- 发件人/收件人信息
- 邮件主题
- 邮件正文（支持HTML渲染）
- 附件列表
- 操作按钮：回复/转发/删除/标记

#### 4.4 撰写邮件界面
- 收件人输入（支持多个）
- 抄送/密送
- 主题输入
- 正文编辑
- 附件添加
- 发送/保存草稿按钮

## 界面布局设计（Kivy KV语言）

```kv
# main.kv
<MailListItem>:
    size_hint_y: None
    height: 80
    BoxLayout:
        orientation: 'vertical'
        padding: 10
        Label:
            text: root.sender
            font_size: 16
            bold: True
        Label:
            text: root.subject
            font_size: 14
        Label:
            text: root.preview
            font_size: 12
            color: 0.5, 0.5, 0.5, 1

<MailListScreen>:
    BoxLayout:
        orientation: 'vertical'
        # 顶部工具栏
        BoxLayout:
            size_hint_y: 0.1
            Button:
                text: '刷新'
            Spinner:
                text: '收件箱'
                values: ['收件箱', '已发送', '草稿箱', '垃圾箱']
        
        # 邮件列表
        ScrollView:
            RecycleView:
                id: mail_list
                viewclass: 'MailListItem'
        
        # 底部按钮
        Button:
            size_hint_y: 0.1
            text: '撰写邮件'
```

## 数据存储方案

### 本地缓存
- **邮件列表缓存**: SQLite数据库
- **邮件内容缓存**: 文件系统（按邮件ID存储）
- **附件缓存**: 独立目录存储

### 数据库表结构
```sql
-- 邮件表
CREATE TABLE emails (
    id TEXT PRIMARY KEY,
    account_id TEXT,
    folder TEXT,
    sender TEXT,
    recipients TEXT,
    subject TEXT,
    date DATETIME,
    body_preview TEXT,
    has_attachment INTEGER,
    is_read INTEGER,
    is_starred INTEGER,
    size INTEGER,
    cached_at DATETIME
);

-- 附件表
CREATE TABLE attachments (
    id INTEGER PRIMARY KEY,
    email_id TEXT,
    filename TEXT,
    size INTEGER,
    mime_type TEXT,
    local_path TEXT,
    FOREIGN KEY(email_id) REFERENCES emails(id)
);
```

## 配置文件

### buildozer.spec
```ini
[app]
title = 邮件客户端
package.name = mailclient
package.domain = com.example
source.dir = .
source.include_exts = py,png,jpg,kv,atlas,json
version = 0.1
requirements = python3,kivy,pillow
permissions = INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE
orientation = portrait
fullscreen = 0
android.api = 31
android.minapi = 21
android.ndk = 25b
android.accept_sdk_license = True
```

## 安全考虑

### 1. 密码存储
- **重要**: 密码仅存储在用户设备本地，永不上传到代码仓库
- 用户首次使用时在登录界面输入邮箱密码
- 使用AES加密 + 设备唯一标识作为密钥
- 配置文件存储在应用私有目录，其他应用无法访问
- **GitHub仓库和APK中不包含任何账户信息**

### 2. 网络通信
- 强制使用SSL/TLS连接
- 验证服务器证书
- 超时设置防止挂起

### 3. 数据隔离
- 每个账户数据独立存储
- 应用卸载时清除所有数据
- 配置文件路径使用应用私有目录（Android: app.user_data_dir）

## 性能优化

### 1. 邮件列表加载
- 分页加载（每次50封）
- 只下载邮件头和预览
- 后台线程异步加载

### 2. 邮件内容加载
- 按需下载完整邮件
- 图片懒加载
- 附件仅下载元数据，点击时才下载内容

### 3. 缓存策略
- 最近7天邮件自动缓存
- LRU策略清理旧缓存
- 离线模式读取缓存

## 错误处理

### 常见错误场景
1. **网络连接失败**: 提示用户检查网络，提供重试按钮
2. **认证失败**: 提示密码错误，引导重新登录
3. **服务器超时**: 显示加载超时，提供刷新选项
4. **附件过大**: 限制附件大小（如25MB），超出提示
5. **存储空间不足**: 清理缓存或提示用户

## 开发计划

### Phase 1: 基础功能（1-2周）
- [x] 项目初始化
- [ ] 账户登录界面
- [ ] IMAP连接和邮件列表获取
- [ ] 邮件列表UI展示
- [ ] 邮件详情查看

### Phase 2: 发送功能（1周）
- [ ] SMTP连接
- [ ] 撰写邮件界面
- [ ] 发送邮件功能
- [ ] 回复/转发功能

### Phase 3: 高级功能（1-2周）
- [ ] 附件支持
- [ ] 多账户管理
- [ ] 本地缓存
- [ ] 搜索功能
- [ ] 推送通知

### Phase 4: 优化和测试（1周）
- [ ] 性能优化
- [ ] UI美化
- [ ] 错误处理完善
- [ ] 真机测试
- [ ] APK打包

## 项目结构

```
mailclient/
├── main.py                 # 应用入口
├── buildozer.spec         # 打包配置
├── requirements.txt       # Python依赖
├── .github/
│   └── workflows/
│       └── build.yml      # GitHub Actions配置
├── src/
│   ├── ui/
│   │   ├── login.py       # 登录界面
│   │   ├── maillist.py    # 邮件列表
│   │   ├── maildetail.py  # 邮件详情
│   │   └── compose.py     # 撰写邮件
│   ├── core/
│   │   ├── imap_client.py # IMAP客户端
│   │   ├── smtp_client.py # SMTP客户端
│   │   ├── account.py     # 账户管理
│   │   └── storage.py     # 数据存储
│   └── utils/
│       ├── config.py      # 配置管理
│       └── crypto.py      # 加密工具
├── assets/
│   ├── icons/             # 图标资源
│   └── fonts/             # 字体文件
└── kv/
    ├── main.kv            # 主界面
    ├── login.kv           # 登录界面
    └── maillist.kv        # 邮件列表界面
```

## 常见邮箱服务商配置

```python
MAIL_PROVIDERS = {
    "gmail.com": {
        "imap": ("imap.gmail.com", 993),
        "smtp": ("smtp.gmail.com", 587),
        "note": "需要开启应用专用密码"
    },
    "outlook.com": {
        "imap": ("outlook.office365.com", 993),
        "smtp": ("smtp.office365.com", 587)
    },
    "qq.com": {
        "imap": ("imap.qq.com", 993),
        "smtp": ("smtp.qq.com", 465),
        "note": "需要开启IMAP/SMTP服务并获取授权码"
    },
    "163.com": {
        "imap": ("imap.163.com", 993),
        "smtp": ("smtp.163.com", 465),
        "note": "需要开启IMAP/SMTP服务并获取授权码"
    }
}
```

## 测试计划

### 单元测试
- IMAP连接测试
- SMTP发送测试
- 邮件解析测试
- 加密解密测试

### 集成测试
- 完整收发邮件流程
- 多账户切换
- 附件上传下载

### UI测试
- 界面响应测试
- 不同屏幕尺寸适配
- 横竖屏切换

## 部署说明

### 本地开发测试
```bash
python3 main.py
```

### 打包APK（需要Linux环境）
```bash
buildozer android debug
```

### GitHub Actions自动构建
推送代码到GitHub后自动触发构建，从Releases下载APK。

## 后续扩展方向

1. **邮件规则**: 自动分类、过滤垃圾邮件
2. **富文本编辑**: 支持格式化文本编辑
3. **联系人管理**: 集成通讯录
4. **日历集成**: 解析会议邀请
5. **多语言支持**: 国际化
6. **主题切换**: 深色模式
7. **手势操作**: 滑动删除、标记等
8. **离线模式**: 完整离线阅读支持

---

**文档版本**: v1.0  
**创建日期**: 2025-11-03  
**最后更新**: 2025-11-03
