# Android APK打包说明

## 方法1: GitHub Actions自动构建（推荐）

### 步骤

1. **创建GitHub仓库**
   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   git remote add origin https://github.com/你的用户名/email-client-py.git
   git push -u origin main
   ```

2. **触发构建**
   - 推送代码后，GitHub Actions会自动开始构建
   - 访问仓库的 Actions 页面查看构建进度
   - 构建时间约15-30分钟（首次构建）

3. **下载APK**
   - 构建完成后，在 Actions 页面点击对应的workflow
   - 在 Artifacts 区域下载 `mailclient-debug.apk`

### 优点
- 无需本地配置环境
- 自动化构建
- 可以在任何平台使用

## 方法2: 本地打包（Linux环境）

### 前置要求
- Linux系统（Ubuntu 20.04+推荐）
- Python 3.8+
- 至少20GB磁盘空间
- 稳定的网络连接

### 步骤

1. **安装依赖**
   ```bash
   sudo apt update
   sudo apt install -y python3-pip git zip unzip openjdk-11-jdk
   pip3 install buildozer cython
   ```

2. **初始化Buildozer**
   ```bash
   cd /path/to/email-client-py
   buildozer init  # 如果已有buildozer.spec则跳过
   ```

3. **构建APK**
   ```bash
   buildozer android debug
   ```
   
   首次构建会下载：
   - Android SDK
   - Android NDK
   - Python-for-Android
   - 各种依赖库
   
   预计时间：30-60分钟

4. **获取APK**
   ```bash
   ls bin/
   # 输出: mailclient-0.1-arm64-v8a-debug.apk
   ```

### 常见问题

**问题1: 构建失败，提示SDK License未接受**
```bash
buildozer android debug
# 按提示接受license
```

**问题2: 内存不足**
- 确保至少有4GB可用内存
- 关闭其他应用程序

**问题3: 网络超时**
- 使用国内镜像源
- 或使用VPN

## 方法3: Docker构建

### 步骤

1. **安装Docker**
   ```bash
   # macOS
   brew install --cask docker
   
   # Ubuntu
   sudo apt install docker.io
   ```

2. **使用Kivy官方镜像构建**
   ```bash
   cd /path/to/email-client-py
   
   docker run --rm -v "$PWD":/app \
     kivy/buildozer android debug
   ```

3. **获取APK**
   ```bash
   ls bin/
   ```

### 优点
- 跨平台（macOS/Windows/Linux都可用）
- 环境隔离，不污染系统
- 可重复构建

## 安装到Android设备

### 方法1: USB连接

1. 在Android设备上开启"开发者选项"和"USB调试"
2. 连接设备到电脑
3. 安装APK：
   ```bash
   adb install bin/mailclient-0.1-arm64-v8a-debug.apk
   ```

### 方法2: 直接传输

1. 将APK文件传输到手机（通过微信/QQ/邮件等）
2. 在手机上打开APK文件
3. 允许"安装未知来源应用"
4. 点击安装

## 签名APK（发布版本）

### 生成密钥

```bash
keytool -genkey -v -keystore my-release-key.keystore \
  -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000
```

### 修改buildozer.spec

```ini
[app]
# ... 其他配置 ...

# 签名配置
android.release_artifact = apk
android.keystore = /path/to/my-release-key.keystore
android.keystore_alias = my-key-alias
android.keystore_password = 你的密码
android.key_alias_password = 你的密码
```

### 构建发布版本

```bash
buildozer android release
```

## 优化APK大小

### 1. 移除未使用的依赖

编辑 `buildozer.spec`:
```ini
requirements = python3,kivy==2.3.0,pycryptodome
# 只保留必需的库
```

### 2. 使用ProGuard混淆

```ini
android.add_gradle_repositories = google(), mavenCentral()
android.gradle_dependencies = 
android.enable_androidx = True
```

### 3. 分架构打包

```ini
android.archs = arm64-v8a
# 或 armeabi-v7a, x86, x86_64
```

## 测试APK

### 在模拟器中测试

```bash
# 启动Android模拟器
emulator -avd Pixel_4_API_30

# 安装APK
adb install bin/mailclient-0.1-arm64-v8a-debug.apk

# 查看日志
adb logcat | grep python
```

### 在真机上测试

1. 安装APK
2. 打开应用
3. 测试所有功能：
   - 登录
   - 查看邮件列表
   - 查看邮件详情
   - 发送邮件
   - 回复邮件

## 故障排查

### 查看构建日志

```bash
# Buildozer日志
cat .buildozer/logs/buildozer.log

# Android日志
adb logcat
```

### 常见错误

**错误1: "No module named 'kivy'"**
- 检查requirements是否正确
- 清理缓存重新构建：`buildozer android clean`

**错误2: "Permission denied"**
- 检查文件权限
- 使用sudo（不推荐）或修改文件所有者

**错误3: APK安装失败**
- 检查Android版本兼容性
- 卸载旧版本后重新安装

## 发布到应用商店

### Google Play

1. 创建开发者账号（$25一次性费用）
2. 创建应用
3. 上传签名的APK
4. 填写应用信息
5. 提交审核

### 其他应用商店

- 小米应用商店
- 华为应用市场
- 应用宝（腾讯）
- 豌豆荚

每个商店都有自己的审核流程和要求。

## 持续集成

### 自动化发布流程

1. 代码推送到GitHub
2. GitHub Actions自动构建
3. 自动上传到Release
4. 用户下载最新版本

参考 `.github/workflows/build.yml` 配置。
